# drugs_in_wastewater_analysis.R
#
# Emiel van Loon (e.e.vanloon@uva.nl), University of Amsterdam
# March 2024

# This analysis script supports the paper "Mapping consumption and market size 
# of cocaine, amphetamine and MDMA through wastewater analysis - a Dutch case 
# study" by Thomas ter Laak et al. (submitted in 2024)

# The study estimates illicit drug consumption and annual market in the 
# Netherlands from wastewater analysis of drug residues (cocaine, amphetamine 
# and methylene dioxymethamphetamine (MDMA)).
# The residues were studied between 2015 and 2022 in 30 Dutch wastewater 
# treatment plants serving both rural and urban populations. 
# These wastewater treatment plants covered 20% of the total Dutch population 
# (17.5 million people). 

# This analysis script goes through the following steps:
# 1. It stores the input data in two data frames. Section '0 Loading data' 
#    (The data is included as part of this script between lines 34 and 590. 
#    This is done for robustness: in this way the script is self-contained; 
#    data can't e.g. get lost when moving the script).
# 2. It fits three GLM models with gamma error distributions, one model for each
#    substance (amfetamine, benzoylecgonine, MDMA). Section '2a Fit separate...'
# 3. It makes predictions with the three fitted models and by using a bootstrap
#    procedure, the 0.95 prediction-intervals are calculated as well.
#    Section '2b Calculate predictions...'
# 4. It saves the results. Section '3 Save results'
#
# For the bootstrap, a so-called case-based procedure is used using B bootstrap
# samples. The algorithm for this is as follows.
# 1. Resample N cases with replacement from the data set containing N original 
#    cases.
# 2. Compute (fit) the model using the bootstrapped data set; produce and save
#    predictions with that model.
# 3. Repeat the process B times
#
# This script can be run interactively, but also in batch-mode by
#     source('drugs_in_sewage_analysis.R').
# It produces the model summaries for three fitted glm-models on the console, 
# three figures (on screen) and a csv-file ("prediction_per_municipality.csv").
#
# This script only uses functions from base-R. Even though the excellent boot 
# and car packages also provide functionality to produce bootstrap estimates 
# (through the functions boot::boot() and car::Boot()) the analyses that were 
# required here were relatively simple so that we implemented them without these
# packages. 
# For explanations about the procedure we refer to Davison and Hinkley (1997)
# and Fox and Weisberg (2019)
#
# Davison, A, and Hinkley, D. (1997) Bootstrap Methods and their Applications. 
# Oxford: Oxford University Press. 
#
# Fox, J. and Weisberg, S. (2019) Bootstrapping Regression Models in R, 
# https://socialsciences.mcmaster.ca/jfox/Books/Companion/appendices/Appendix-Bootstrapping.pdf. 


#### 0 Loading data ####

D <- structure(list(year = c(2015.9370289999999, 2015.9370289999999, 
2015.9370289999999, 2015.9370289999999, 2015.9370289999999, 2015.9370289999999, 
2015.9370289999999, 2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 
2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 
2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 
2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 
2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 
2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 
2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 
2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 
2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 
2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 
2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 
2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 
2016.1889120000001, 2016.1889120000001, 2016.454483, 2016.454483, 
2016.454483, 2016.454483, 2016.454483, 2016.454483, 2016.454483, 
2016.7446950000001, 2016.7446950000001, 2016.7446950000001, 2016.7446950000001, 
2016.7446950000001, 2016.7446950000001, 2016.7446950000001, 2017.300479, 
2017.300479, 2017.300479, 2017.300479, 2017.300479, 2017.300479, 
2017.300479, 2018.377976, 2018.377976, 2018.377976, 2018.377976, 
2018.377976, 2018.377976, 2018.377976, 2018.776523, 2018.776523, 
2018.776523, 2018.776523, 2018.776523, 2018.776523, 2018.776523, 
2019.23614, 2019.23614, 2019.23614, 2019.23614, 2019.23614, 2019.23614, 
2019.23614, 2019.4287019999999, 2019.4287019999999, 2019.4287019999999, 
2019.4287019999999, 2019.4287019999999, 2019.4287019999999, 2019.4287019999999, 
2019.7152639999999, 2019.7152639999999, 2019.7152639999999, 2019.7152639999999, 
2019.7152639999999, 2019.7152639999999, 2019.7152639999999, 2020.2135519999999, 
2020.2135519999999, 2020.2135519999999, 2020.2135519999999, 2020.2135519999999, 
2020.2135519999999, 2020.2135519999999, 2021.2101299999999, 2021.2101299999999, 
2021.2101299999999, 2021.2101299999999, 2021.2101299999999, 2021.2101299999999, 
2021.2101299999999, 2021.2101299999999, 2021.2101299999999, 2021.2101299999999, 
2021.2101299999999, 2021.2101299999999, 2021.2101299999999, 2021.2101299999999, 
2021.7426419999999, 2021.7426419999999, 2021.7426419999999, 2021.7426419999999, 
2021.7426419999999, 2021.7426419999999, 2021.7426419999999, 2022.187543, 
2022.187543, 2022.187543, 2022.187543, 2022.187543, 2022.187543, 
2022.187543, 2022.187543, 2022.187543, 2022.187543, 2022.187543, 
2022.187543, 2022.187543, 2022.187543, 2015.9370289999999, 2015.9370289999999, 
2015.9370289999999, 2015.9370289999999, 2015.9370289999999, 2015.9370289999999, 
2015.9370289999999, 2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 
2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 
2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 
2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 
2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 
2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 
2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 
2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 
2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 
2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 
2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 
2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 
2016.1889120000001, 2016.1889120000001, 2016.454483, 2016.454483, 
2016.454483, 2016.454483, 2016.454483, 2016.454483, 2016.454483, 
2016.7446950000001, 2016.7446950000001, 2016.7446950000001, 2016.7446950000001, 
2016.7446950000001, 2016.7446950000001, 2016.7446950000001, 2017.300479, 
2017.300479, 2017.300479, 2017.300479, 2017.300479, 2017.300479, 
2017.300479, 2018.377976, 2018.377976, 2018.377976, 2018.377976, 
2018.377976, 2018.377976, 2018.377976, 2018.776523, 2018.776523, 
2018.776523, 2018.776523, 2018.776523, 2018.776523, 2018.776523, 
2019.23614, 2019.23614, 2019.23614, 2019.23614, 2019.23614, 2019.23614, 
2019.23614, 2019.4287019999999, 2019.4287019999999, 2019.4287019999999, 
2019.4287019999999, 2019.4287019999999, 2019.4287019999999, 2019.4287019999999, 
2019.7152639999999, 2019.7152639999999, 2019.7152639999999, 2019.7152639999999, 
2019.7152639999999, 2019.7152639999999, 2019.7152639999999, 2020.2135519999999, 
2020.2135519999999, 2020.2135519999999, 2020.2135519999999, 2020.2135519999999, 
2020.2135519999999, 2020.2135519999999, 2021.2101299999999, 2021.2101299999999, 
2021.2101299999999, 2021.2101299999999, 2021.2101299999999, 2021.2101299999999, 
2021.2101299999999, 2021.2101299999999, 2021.2101299999999, 2021.2101299999999, 
2021.2101299999999, 2021.2101299999999, 2021.2101299999999, 2021.2101299999999, 
2021.7426419999999, 2021.7426419999999, 2021.7426419999999, 2021.7426419999999, 
2021.7426419999999, 2021.7426419999999, 2021.7426419999999, 2022.187543, 
2022.187543, 2022.187543, 2022.187543, 2022.187543, 2022.187543, 
2022.187543, 2022.187543, 2022.187543, 2022.187543, 2022.187543, 
2022.187543, 2022.187543, 2022.187543, 2015.9370289999999, 2015.9370289999999, 
2015.9370289999999, 2015.9370289999999, 2015.9370289999999, 2015.9370289999999, 
2015.9370289999999, 2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 
2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 
2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 
2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 
2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 
2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 
2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 
2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 
2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 
2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 
2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 
2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 2016.1889120000001, 
2016.1889120000001, 2016.1889120000001, 2016.454483, 2016.454483, 
2016.454483, 2016.454483, 2016.454483, 2016.454483, 2016.454483, 
2016.7446950000001, 2016.7446950000001, 2016.7446950000001, 2016.7446950000001, 
2016.7446950000001, 2016.7446950000001, 2016.7446950000001, 2017.300479, 
2017.300479, 2017.300479, 2017.300479, 2017.300479, 2017.300479, 
2017.300479, 2018.377976, 2018.377976, 2018.377976, 2018.377976, 
2018.377976, 2018.377976, 2018.377976, 2018.776523, 2018.776523, 
2018.776523, 2018.776523, 2018.776523, 2018.776523, 2018.776523, 
2019.23614, 2019.23614, 2019.23614, 2019.23614, 2019.23614, 2019.23614, 
2019.23614, 2019.4287019999999, 2019.4287019999999, 2019.4287019999999, 
2019.4287019999999, 2019.4287019999999, 2019.4287019999999, 2019.4287019999999, 
2019.7152639999999, 2019.7152639999999, 2019.7152639999999, 2019.7152639999999, 
2019.7152639999999, 2019.7152639999999, 2019.7152639999999, 2020.2135519999999, 
2020.2135519999999, 2020.2135519999999, 2020.2135519999999, 2020.2135519999999, 
2020.2135519999999, 2020.2135519999999, 2021.2101299999999, 2021.2101299999999, 
2021.2101299999999, 2021.2101299999999, 2021.2101299999999, 2021.2101299999999, 
2021.2101299999999, 2021.2101299999999, 2021.2101299999999, 2021.2101299999999, 
2021.2101299999999, 2021.2101299999999, 2021.2101299999999, 2021.2101299999999, 
2021.7426419999999, 2021.7426419999999, 2021.7426419999999, 2021.7426419999999, 
2021.7426419999999, 2021.7426419999999, 2021.7426419999999, 2022.187543, 
2022.187543, 2022.187543, 2022.187543, 2022.187543, 2022.187543, 
2022.187543, 2022.187543, 2022.187543, 2022.187543, 2022.187543, 
2022.187543, 2022.187543, 2022.187543), 
urbscore = c(0.56294279999999997, 
0.56294279999999997, 0.56294279999999997, 0.56294279999999997, 
0.56294279999999997, 0.56294279999999997, 0.56294279999999997, 
0.20377319999999999, 0.20377319999999999, 0.20377319999999999, 
0.20377319999999999, 0.20377319999999999, 0.20377319999999999, 
0.20377319999999999, 0.55114799999999997, 0.55114799999999997, 
0.55114799999999997, 0.55114799999999997, 0.55114799999999997, 
0.55114799999999997, 0.55114799999999997, 0.093816250000000004, 
0.093816250000000004, 0.093816250000000004, 0.093816250000000004, 
0.093816250000000004, 0.093816250000000004, 0.093816250000000004, 
0.21752540000000001, 0.21752540000000001, 0.21752540000000001, 
0.21752540000000001, 0.21752540000000001, 0.21752540000000001, 
0.21752540000000001, 0.32082480000000002, 0.32082480000000002, 
0.32082480000000002, 0.32082480000000002, 0.32082480000000002, 
0.32082480000000002, 0.32082480000000002, 0.4113559, 0.4113559, 
0.4113559, 0.4113559, 0.4113559, 0.4113559, 0.4113559, 0.45723570000000002, 
0.45723570000000002, 0.45723570000000002, 0.45723570000000002, 
0.45723570000000002, 0.45723570000000002, 0.45723570000000002, 
0.72315790000000002, 0.72315790000000002, 0.72315790000000002, 
0.72315790000000002, 0.72315790000000002, 0.72315790000000002, 
0.72315790000000002, 0.29124670000000003, 0.29124670000000003, 
0.29124670000000003, 0.29124670000000003, 0.29124670000000003, 
0.29124670000000003, 0.29124670000000003, 0.70725879999999997, 
0.70725879999999997, 0.70725879999999997, 0.70725879999999997, 
0.70725879999999997, 0.70725879999999997, 0.70725879999999997, 
0.79807450000000002, 0.79807450000000002, 0.79807450000000002, 
0.79807450000000002, 0.79807450000000002, 0.79807450000000002, 
0.79807450000000002, 0.61404959999999997, 0.61404959999999997, 
0.61404959999999997, 0.61404959999999997, 0.61404959999999997, 
0.61404959999999997, 0.61404959999999997, 0.53820650000000003, 
0.53820650000000003, 0.53820650000000003, 0.53820650000000003, 
0.53820650000000003, 0.53820650000000003, 0.53820650000000003, 
0.93489310000000003, 0.93489310000000003, 0.93489310000000003, 
0.93489310000000003, 0.93489310000000003, 0.93489310000000003, 
0.93489310000000003, 0.21949289999999999, 0.21949289999999999, 
0.21949289999999999, 0.21949289999999999, 0.21949289999999999, 
0.21949289999999999, 0.21949289999999999, 0.93252179999999996, 
0.93252179999999996, 0.93252179999999996, 0.93252179999999996, 
0.93252179999999996, 0.93252179999999996, 0.93252179999999996, 
0.89062810000000003, 0.89062810000000003, 0.89062810000000003, 
0.89062810000000003, 0.89062810000000003, 0.89062810000000003, 
0.89062810000000003, 0.85334690000000002, 0.85334690000000002, 
0.85334690000000002, 0.85334690000000002, 0.85334690000000002, 
0.85334690000000002, 0.85334690000000002, 0.68725360000000002, 
0.68725360000000002, 0.68725360000000002, 0.68725360000000002, 
0.68725360000000002, 0.68725360000000002, 0.68725360000000002, 
0.73708609999999997, 0.73708609999999997, 0.73708609999999997, 
0.73708609999999997, 0.73708609999999997, 0.73708609999999997, 
0.73708609999999997, 0.57243180000000005, 0.57243180000000005, 
0.57243180000000005, 0.57243180000000005, 0.57243180000000005, 
0.57243180000000005, 0.57243180000000005, 0.56294279999999997, 
0.56294279999999997, 0.56294279999999997, 0.56294279999999997, 
0.56294279999999997, 0.56294279999999997, 0.56294279999999997, 
0.20377319999999999, 0.20377319999999999, 0.20377319999999999, 
0.20377319999999999, 0.20377319999999999, 0.20377319999999999, 
0.20377319999999999, 0.55114799999999997, 0.55114799999999997, 
0.55114799999999997, 0.55114799999999997, 0.55114799999999997, 
0.55114799999999997, 0.55114799999999997, 0.093816250000000004, 
0.093816250000000004, 0.093816250000000004, 0.093816250000000004, 
0.093816250000000004, 0.093816250000000004, 0.093816250000000004, 
0.21752540000000001, 0.21752540000000001, 0.21752540000000001, 
0.21752540000000001, 0.21752540000000001, 0.21752540000000001, 
0.21752540000000001, 0.32082480000000002, 0.32082480000000002, 
0.32082480000000002, 0.32082480000000002, 0.32082480000000002, 
0.32082480000000002, 0.32082480000000002, 0.4113559, 0.4113559, 
0.4113559, 0.4113559, 0.4113559, 0.4113559, 0.4113559, 0.45723570000000002, 
0.45723570000000002, 0.45723570000000002, 0.45723570000000002, 
0.45723570000000002, 0.45723570000000002, 0.45723570000000002, 
0.72315790000000002, 0.72315790000000002, 0.72315790000000002, 
0.72315790000000002, 0.72315790000000002, 0.72315790000000002, 
0.72315790000000002, 0.29124670000000003, 0.29124670000000003, 
0.29124670000000003, 0.29124670000000003, 0.29124670000000003, 
0.29124670000000003, 0.29124670000000003, 0.70725879999999997, 
0.70725879999999997, 0.70725879999999997, 0.70725879999999997, 
0.70725879999999997, 0.70725879999999997, 0.70725879999999997, 
0.79807450000000002, 0.79807450000000002, 0.79807450000000002, 
0.79807450000000002, 0.79807450000000002, 0.79807450000000002, 
0.79807450000000002, 0.61404959999999997, 0.61404959999999997, 
0.61404959999999997, 0.61404959999999997, 0.61404959999999997, 
0.61404959999999997, 0.61404959999999997, 0.53820650000000003, 
0.53820650000000003, 0.53820650000000003, 0.53820650000000003, 
0.53820650000000003, 0.53820650000000003, 0.53820650000000003, 
0.93489310000000003, 0.93489310000000003, 0.93489310000000003, 
0.93489310000000003, 0.93489310000000003, 0.93489310000000003, 
0.93489310000000003, 0.21949289999999999, 0.21949289999999999, 
0.21949289999999999, 0.21949289999999999, 0.21949289999999999, 
0.21949289999999999, 0.21949289999999999, 0.93252179999999996, 
0.93252179999999996, 0.93252179999999996, 0.93252179999999996, 
0.93252179999999996, 0.93252179999999996, 0.93252179999999996, 
0.89062810000000003, 0.89062810000000003, 0.89062810000000003, 
0.89062810000000003, 0.89062810000000003, 0.89062810000000003, 
0.89062810000000003, 0.85334690000000002, 0.85334690000000002, 
0.85334690000000002, 0.85334690000000002, 0.85334690000000002, 
0.85334690000000002, 0.85334690000000002, 0.68725360000000002, 
0.68725360000000002, 0.68725360000000002, 0.68725360000000002, 
0.68725360000000002, 0.68725360000000002, 0.68725360000000002, 
0.73708609999999997, 0.73708609999999997, 0.73708609999999997, 
0.73708609999999997, 0.73708609999999997, 0.73708609999999997, 
0.73708609999999997, 0.57243180000000005, 0.57243180000000005, 
0.57243180000000005, 0.57243180000000005, 0.57243180000000005, 
0.57243180000000005, 0.57243180000000005, 0.56294279999999997, 
0.56294279999999997, 0.56294279999999997, 0.56294279999999997, 
0.56294279999999997, 0.56294279999999997, 0.56294279999999997, 
0.20377319999999999, 0.20377319999999999, 0.20377319999999999, 
0.20377319999999999, 0.20377319999999999, 0.20377319999999999, 
0.20377319999999999, 0.55114799999999997, 0.55114799999999997, 
0.55114799999999997, 0.55114799999999997, 0.55114799999999997, 
0.55114799999999997, 0.55114799999999997, 0.093816250000000004, 
0.093816250000000004, 0.093816250000000004, 0.093816250000000004, 
0.093816250000000004, 0.093816250000000004, 0.093816250000000004, 
0.21752540000000001, 0.21752540000000001, 0.21752540000000001, 
0.21752540000000001, 0.21752540000000001, 0.21752540000000001, 
0.21752540000000001, 0.32082480000000002, 0.32082480000000002, 
0.32082480000000002, 0.32082480000000002, 0.32082480000000002, 
0.32082480000000002, 0.32082480000000002, 0.4113559, 0.4113559, 
0.4113559, 0.4113559, 0.4113559, 0.4113559, 0.4113559, 0.45723570000000002, 
0.45723570000000002, 0.45723570000000002, 0.45723570000000002, 
0.45723570000000002, 0.45723570000000002, 0.45723570000000002, 
0.72315790000000002, 0.72315790000000002, 0.72315790000000002, 
0.72315790000000002, 0.72315790000000002, 0.72315790000000002, 
0.72315790000000002, 0.29124670000000003, 0.29124670000000003, 
0.29124670000000003, 0.29124670000000003, 0.29124670000000003, 
0.29124670000000003, 0.29124670000000003, 0.70725879999999997, 
0.70725879999999997, 0.70725879999999997, 0.70725879999999997, 
0.70725879999999997, 0.70725879999999997, 0.70725879999999997, 
0.79807450000000002, 0.79807450000000002, 0.79807450000000002, 
0.79807450000000002, 0.79807450000000002, 0.79807450000000002, 
0.79807450000000002, 0.61404959999999997, 0.61404959999999997, 
0.61404959999999997, 0.61404959999999997, 0.61404959999999997, 
0.61404959999999997, 0.61404959999999997, 0.53820650000000003, 
0.53820650000000003, 0.53820650000000003, 0.53820650000000003, 
0.53820650000000003, 0.53820650000000003, 0.53820650000000003, 
0.93489310000000003, 0.93489310000000003, 0.93489310000000003, 
0.93489310000000003, 0.93489310000000003, 0.93489310000000003, 
0.93489310000000003, 0.21949289999999999, 0.21949289999999999, 
0.21949289999999999, 0.21949289999999999, 0.21949289999999999, 
0.21949289999999999, 0.21949289999999999, 0.93252179999999996, 
0.93252179999999996, 0.93252179999999996, 0.93252179999999996, 
0.93252179999999996, 0.93252179999999996, 0.93252179999999996, 
0.89062810000000003, 0.89062810000000003, 0.89062810000000003, 
0.89062810000000003, 0.89062810000000003, 0.89062810000000003, 
0.89062810000000003, 0.85334690000000002, 0.85334690000000002, 
0.85334690000000002, 0.85334690000000002, 0.85334690000000002, 
0.85334690000000002, 0.85334690000000002, 0.68725360000000002, 
0.68725360000000002, 0.68725360000000002, 0.68725360000000002, 
0.68725360000000002, 0.68725360000000002, 0.68725360000000002, 
0.73708609999999997, 0.73708609999999997, 0.73708609999999997, 
0.73708609999999997, 0.73708609999999997, 0.73708609999999997, 
0.73708609999999997, 0.57243180000000005, 0.57243180000000005, 
0.57243180000000005, 0.57243180000000005, 0.57243180000000005, 
0.57243180000000005, 0.57243180000000005), 
substance = structure(
c(1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 
1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 
1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 
1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 
1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 
1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 
1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 
1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 
1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 
1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 
2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 
2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 
2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 
2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 
2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 
2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 
2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 
2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 
2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 
2L, 2L, 2L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 
3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 
3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 
3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 
3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 
3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 
3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 
3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 
3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 
3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L, 3L), levels = c("amfetamine", 
"benzoylecgonine", "MDMA"), class = "factor"), 
day = structure(
c(5L, 2L, 4L, 6L, 7L, 3L, 1L, 5L, 2L, 4L, 6L, 7L, 3L, 1L, 5L, 2L, 4L, 
6L, 7L, 3L, 1L, 5L, 2L, 4L, 6L, 7L, 3L, 1L, 5L, 2L, 4L, 6L, 7L, 
3L, 1L, 5L, 2L, 4L, 6L, 7L, 3L, 1L, 5L, 2L, 4L, 6L, 7L, 3L, 1L, 
5L, 2L, 4L, 6L, 7L, 3L, 1L, 5L, 2L, 4L, 6L, 7L, 3L, 1L, 5L, 2L, 
4L, 6L, 7L, 3L, 1L, 5L, 2L, 4L, 6L, 7L, 3L, 1L, 5L, 2L, 4L, 6L, 
7L, 3L, 1L, 5L, 2L, 4L, 6L, 7L, 3L, 1L, 5L, 2L, 4L, 6L, 7L, 3L, 
1L, 5L, 2L, 4L, 6L, 7L, 3L, 1L, 5L, 2L, 4L, 6L, 7L, 3L, 1L, 5L, 
2L, 4L, 6L, 7L, 3L, 1L, 5L, 2L, 4L, 6L, 7L, 3L, 1L, 5L, 2L, 4L, 
6L, 7L, 3L, 1L, 5L, 2L, 4L, 6L, 7L, 3L, 1L, 5L, 2L, 4L, 6L, 7L, 
3L, 1L, 5L, 2L, 4L, 6L, 7L, 3L, 1L, 5L, 2L, 4L, 6L, 7L, 3L, 1L, 
5L, 2L, 4L, 6L, 7L, 3L, 1L, 5L, 2L, 4L, 6L, 7L, 3L, 1L, 5L, 2L, 
4L, 6L, 7L, 3L, 1L, 5L, 2L, 4L, 6L, 7L, 3L, 1L, 5L, 2L, 4L, 6L, 
7L, 3L, 1L, 5L, 2L, 4L, 6L, 7L, 3L, 1L, 5L, 2L, 4L, 6L, 7L, 3L, 
1L, 5L, 2L, 4L, 6L, 7L, 3L, 1L, 5L, 2L, 4L, 6L, 7L, 3L, 1L, 5L, 
2L, 4L, 6L, 7L, 3L, 1L, 5L, 2L, 4L, 6L, 7L, 3L, 1L, 5L, 2L, 4L, 
6L, 7L, 3L, 1L, 5L, 2L, 4L, 6L, 7L, 3L, 1L, 5L, 2L, 4L, 6L, 7L, 
3L, 1L, 5L, 2L, 4L, 6L, 7L, 3L, 1L, 5L, 2L, 4L, 6L, 7L, 3L, 1L, 
5L, 2L, 4L, 6L, 7L, 3L, 1L, 5L, 2L, 4L, 6L, 7L, 3L, 1L, 5L, 2L, 
4L, 6L, 7L, 3L, 1L, 5L, 2L, 4L, 6L, 7L, 3L, 1L, 5L, 2L, 4L, 6L, 
7L, 3L, 1L, 5L, 2L, 4L, 6L, 7L, 3L, 1L, 5L, 2L, 4L, 6L, 7L, 3L, 
1L, 5L, 2L, 4L, 6L, 7L, 3L, 1L, 5L, 2L, 4L, 6L, 7L, 3L, 1L, 5L, 
2L, 4L, 6L, 7L, 3L, 1L, 5L, 2L, 4L, 6L, 7L, 3L, 1L, 5L, 2L, 4L, 
6L, 7L, 3L, 1L, 5L, 2L, 4L, 6L, 7L, 3L, 1L, 5L, 2L, 4L, 6L, 7L, 
3L, 1L, 5L, 2L, 4L, 6L, 7L, 3L, 1L, 5L, 2L, 4L, 6L, 7L, 3L, 1L, 
5L, 2L, 4L, 6L, 7L, 3L, 1L, 5L, 2L, 4L, 6L, 7L, 3L, 1L, 5L, 2L, 
4L, 6L, 7L, 3L, 1L, 5L, 2L, 4L, 6L, 7L, 3L, 1L, 5L, 2L, 4L, 6L, 
7L, 3L, 1L, 5L, 2L, 4L, 6L, 7L, 3L, 1L, 5L, 2L, 4L, 6L, 7L, 3L, 
1L, 5L, 2L, 4L, 6L, 7L, 3L, 1L, 5L, 2L, 4L, 6L, 7L, 3L, 1L, 5L, 
2L, 4L, 6L, 7L, 3L, 1L, 5L, 2L, 4L, 6L, 7L, 3L, 1L), 
levels = c("di", "do", "ma", "vr", "wo", "za", "zo"), class = "factor"), 
value = c(285.01999999999998, 
439.02999999999997, 292.2577, 824.96010000000001, 253.83260000000001, 
332.56970000000001, 629.12, 65.269999999999996, 75.269999999999996, 
287.43790000000001, 110.6074, 123.2277, 51.740650000000002, 36.18, 
51.950000000000003, 61.689999999999998, 67.633920000000003, 72.026079999999993, 
74.431110000000004, 100.337, 75.920000000000002, 163.33000000000001, 
65.280000000000001, 129.8597, 177.98240000000001, 244.36369999999999, 
195.136, 155.97, 74, 80.340000000000003, 57.719520000000003, 
63.181629999999998, 72.944100000000006, 77.481899999999996, 86.959999999999994, 
154.25999999999999, 125.83, 102.70529999999999, 174.2944, 232.81190000000001, 
282.59870000000001, 136.16999999999999, 64.609999999999999, 68.959999999999994, 
95.646649999999994, 101.5912, 104.6442, 84.843990000000005, 73.340000000000003, 
70.189999999999998, 44.5, 32.267510000000001, 29.652660000000001, 
55.426810000000003, 66.590360000000004, 71.359999999999999, 42.920000000000002, 
68.810000000000002, 61.411090000000002, 86.621729999999999, 88.380099999999999, 
100.2393, 56.960000000000001, 332.22000000000003, 215.63, 264.86219999999997, 
541.30460000000005, 311.94319999999999, 353.60879999999997, 316.99000000000001, 
88.469999999999999, 70.459999999999994, 85.412689999999998, 67.199809999999999, 
88.008330000000001, 102.3449, 75.010000000000005, 154.46000000000001, 
552.27999999999997, 248.4324, 188.63570000000001, 168.9547, 162.79570000000001, 
151.66999999999999, 196.94999999999999, 227.93000000000001, 211.1241, 
235.13640000000001, 230.09440000000001, 571.99530000000004, 336.33999999999997, 
191.43000000000001, 194.56999999999999, 188.71469999999999, 206.21100000000001, 
563.19529999999997, 296.5077, 121.06999999999999, 169.24000000000001, 
137.99000000000001, 142.58539999999999, 227.6105, 156.21199999999999, 
154.87530000000001, 156.47999999999999, 463.83999999999997, 409.51999999999998, 
470.7801, 556.89430000000004, 686.60389999999995, 506.37830000000002, 
569.38999999999999, 333.39999999999998, 356.75, 316.72660000000002, 
222.8588, 210.41919999999999, 170.4521, 396.88999999999999, 262.14999999999998, 
207.44999999999999, 280.72210000000001, 331.7681, 329.25409999999999, 
287.39370000000002, 495.72000000000003, NA, NA, NA, NA, NA, NA, 
NA, 346.13, 336.02999999999997, 319.77089999999998, 410.1619, 
362.42290000000003, 332.416, 295.36000000000001, 258.81999999999999, 
289.06, 328.49590000000001, 336.53489999999999, 343.35270000000003, 
288.54360000000003, 347.69999999999999, 916.04999999999995, 388.62, 
343.9427, 450.04430000000002, 740.92020000000002, 349.66849999999999, 
360.32999999999998, 245.24000000000001, 411.68000000000001, 309.27679999999998, 
958.95280000000002, 430.94839999999999, 527.4348, 582.25999999999999, 
103.56, 94.370000000000005, 130.24170000000001, 219.07550000000001, 
309.69549999999998, 125.06180000000001, 114.65000000000001, 158.50999999999999, 
246.28999999999999, 231.4451, 264.22669999999999, 341.34879999999998, 
278.39460000000003, 163.40000000000001, 114.16, 178.87, 163.7954, 
294.22379999999998, 398.98700000000002, 285.34160000000003, 132.88, 
262.19999999999999, 235.05000000000001, 327.53660000000002, 326.65600000000001, 
535.96879999999999, 261.24509999999998, 222.16999999999999, 177.72, 
181.50999999999999, 210.31970000000001, 359.39859999999999, 386.70150000000001, 
260.25220000000002, 146.56999999999999, 191.78999999999999, 163.47999999999999, 
199.0941, 293.15429999999998, 409.4341, 249.4426, 165.16999999999999, 
245.12, 219.88999999999999, 208.81200000000001, 323.66090000000003, 
357.52159999999998, 261.82100000000003, 195.72, 324.13, 343.19, 
381.11419999999998, 525.10789999999997, 616.79999999999995, 492.53449999999998, 
325.74000000000001, 221.38999999999999, 239.97999999999999, 256.67849999999999, 
387.07220000000001, 565.33399999999995, 418.30439999999999, 238.03, 
258.02999999999997, 255.44999999999999, 310.66419999999999, 383.73489999999998, 
435.72370000000001, 359.23340000000002, 257.07999999999998, 386.31, 
385.60000000000002, 414.18369999999999, 507.4538, 484.07729999999998, 
386.99560000000002, 371.39999999999998, 490.55000000000001, 412.01999999999998, 
498.10210000000001, 602.06949999999995, 712.41189999999995, 561.03390000000002, 
441.02999999999997, 517.72000000000003, 476.06999999999999, 515.05550000000005, 
660.09339999999997, 998.64409999999998, 889.5231, 335.36000000000001, 
807.88999999999999, 849.54999999999995, 884.75390000000004, 1034.434, 
1205.5820000000001, 1103.423, 964.90999999999997, 185.90000000000001, 
151.25, 163.02369999999999, 265.48809999999997, 335.04309999999998, 
210.53110000000001, 196.97, 650.97000000000003, 666.96000000000004, 
692.7654, 1097.4290000000001, 977.62180000000001, 657.62260000000003, 
853.09000000000003, 732.57000000000005, 638.26999999999998, 795.35249999999996, 
1136.982, 1124.173, 892.62419999999997, 849.13, 351.13999999999999, 
366.56, 482.62110000000001, 613.21230000000003, 703.46939999999995, 
564.12670000000003, 551.85000000000002, 325.5, 303.48000000000002, 
349.00889999999998, 443.11000000000001, 499.25999999999999, 406.69880000000001, 
296.64999999999998, 714.77999999999997, 705.99000000000001, 698.06299999999999, 
1130.9639999999999, 1096.133, 901.01220000000001, 721.80999999999995, 
422.94, 530.88999999999999, 504.88850000000002, 746.49929999999995, 
651.34500000000003, 593.15549999999996, 367.07999999999998, 23.920000000000002, 
21.73, 7.3357859999999997, 57.21848, 44.028779999999998, 112.87739999999999, 
88.480000000000004, 20.710000000000001, 17.850000000000001, 24.824000000000002, 
40.133580000000002, 89.050669999999997, 52.037750000000003, 20.690000000000001, 
29.600000000000001, 24.98, 19.519159999999999, 63.590409999999999, 
114.43989999999999, 83.779240000000001, 39.719999999999999, 47.079999999999998, 
20.449999999999999, 11.73588, 50.105890000000002, 87.248140000000006, 
88.529499999999999, 49.789999999999999, 16.239999999999998, 0, 
57.447279999999999, 56.622549999999997, 117.7598, 55.130159999999997, 
53.020000000000003, 18.710000000000001, 12.039999999999999, 10.886480000000001, 
77.89546, 173.74590000000001, 82.054469999999995, 31.890000000000001, 
20.73, 16.5, 12.59638, 53.27111, 101.79000000000001, 48.87847, 
32.890000000000001, 43.869999999999997, 32, 22.502770000000002, 
33.582120000000003, 116.41549999999999, 57.210039999999999, 55.82, 
35.939999999999998, 28.800000000000001, 30.214780000000001, 63.470419999999997, 
141.91980000000001, 122.47020000000001, 53.009999999999998, 56.609999999999999, 
24.07, 24.43064, 62.37276, 135.8409, 69.126630000000006, 50.600000000000001, 
47.420000000000002, 25.98, 37.657559999999997, 42.105829999999997, 
77.528829999999999, 72.959630000000004, 41.079999999999998, 82.579999999999998, 
57.030000000000001, 63.620350000000002, 134.12819999999999, 180.4436, 
135.81489999999999, 92.959999999999994, 103.81, 79.989999999999995, 
95.528679999999994, 96.040599999999998, 212.3595, 169.88409999999999, 
110.53, 82.659999999999997, 44.5, 43.790140000000001, 75.283379999999994, 
859.78920000000005, 369.76249999999999, 77.480000000000004, 189.68000000000001, 
122.25, 127.9881, 158.13730000000001, 267.94200000000001, 274.09690000000001, 
243.81, 43.350000000000001, 29.09, 28.004190000000001, 48.199919999999999, 
113.68000000000001, 80.045140000000004, 55.840000000000003, 57.189999999999998, 
79.939999999999998, 77.105739999999997, 110.8271, 161.95189999999999, 
101.34990000000001, 103.79000000000001, 52.369999999999997, 46.719999999999999, 
59.766019999999997, 145.34710000000001, 180.76990000000001, 141.9605, 
78.579999999999998, 26.309999999999999, 23.870000000000001, 45.074939999999998, 
77.308340000000001, 128.98840000000001, 82.205669999999998, 124.31, 
27.039999999999999, 24.77, 26.199719999999999, 43.301189999999998, 
80.763850000000005, 81.532309999999995, 48.439999999999998, 64.920000000000002, 
42.770000000000003, 34.66216, 72.186239999999998, 187.33629999999999, 
147.8049, 89.340000000000003, 41.060000000000002, 28.789999999999999, 
34.250599999999999, 126.1087, 53.200400000000002, 119.4721, 76.060000000000002)), 
row.names = c(NA, -462L), class = "data.frame")

Dp <-
structure(list(municipality = c("Netherlands", "Ameland", "Noord-Beveland", 
"Schiermonnikoog", "Terschelling", "Vlieland", "Westerveld", 
"De Wolden", "Aa en Hunze", "Westerwolde", "Buren", "Borger-Odoorn", 
"Gulpen-Wittem", "Tubbergen", "Alphen-Chaam", "Roerdalen", "Bergen (L.)", 
"West Maas en Waal", "Borsele", "Veere", "Molenlanden", "Maasgouw", 
"Staphorst", "Leudal", "Opsterland", "Lopik", "Bronckhorst", 
"Midden-Drenthe", "Het Hogeland", "Dantumadiel", "West Betuwe", 
"Waadhoeke", "Achtkarspelen", "Sluis", "Hollands Kroon", "Maasdriel", 
"Tytsjerksteradiel", "Ooststellingwerf", "Koggenland", "Westerkwartier", 
"Voerendaal", "Hulst", "Noardeast-Frysl\x83n", "Olst-Wijhe", 
"Beekdaelen", "Baarle-Nassau", "Altena", "Eijsden-Margraten", 
"Mook en Middelaar", "Pekela", "Neder-Betuwe", "Dinkelland", 
"Tholen", "Bergeijk", "Coevorden", "Drechterland", "Tynaarlo", 
"Schouwen-Duiveland", "Nieuwkoop", "Medemblik", "Reimerswaal", 
"Meerssen", "Renswoude", "Dalfsen", "Boekel", "Hardenberg", "Opmeer", 
"Twenterand", "Voorst", "Ommen", "Eersel", "Reusel-De Mierden", 
"De Fryske Marren", "Valkenburg aan de Geul", "Hilvarenbeek", 
"Horst aan de Maas", "Steenwijkerland", "Oirschot", "Peel en Maas", 
"Cranendonck", "Bunnik", "Wijdemeren", "Zundert", "Land van Cuijk", 
"Heeze-Leende", "Westvoorne", "Sint-Michielsgestel", "Berg en Dal", 
"Hof van Twente", "Lochem", "Weststellingwerf", "Heerde", "Zaltbommel", 
"Simpelveld", "Texel", "Nederweert", "Gennep", "Raalte", "Eemsdelta", 
"Waterland", "Laarbeek", "Oude IJsselstreek", "Berkelland", "Kaag en Braassem", 
"Son en Breugel", "Bernheze", "Oldebroek", "Goeree-Overflakkee", 
"Zwartewaterland", "Kapelle", "Noordenveld", "Losser", "Rucphen", 
"Echt-Susteren", "Woensdrecht", "Halderberge", "Drimmelen", "Steenbergen", 
"Noordoostpolder", "Wierden", "Elburg", "Montfoort", "Montferland", 
"Beesel", "Epe", "Oost Gelre", "Aalten", "Bladel", "Heumen", 
"Moerdijk", "Stadskanaal", "Schagen", "Someren", "Oldambt", "Krimpenerwaard", 
"S\xa3dwest-Frysl\x83n", "Utrechtse Heuvelrug", "Dronten", "Emmen", 
"Doesburg", "Terneuzen", "Druten", "Midden-Groningen", "Nunspeet", 
"Hoeksche Waard", "Brummen", "Beek (L.)", "Hellendoorn", "Hattem", 
"Gemert-Bakel", "Overbetuwe", "Oudewater", "Bergen (NH.)", "Waalre", 
"Vijfheerenlanden", "Deurne", "Brielle", "Stein (L.)", "Asten", 
"Rozendaal", "Rhenen", "Zoeterwoude", "Zevenaar", "Renkum", "Barneveld", 
"Eemnes", "Heerenveen", "Hardinxveld-Giessendam", "Scherpenzeel", 
"Lingewaard", "De Ronde Venen", "Oisterwijk", "Aalsmeer", "Zeewolde", 
"Woudenberg", "Meierijstad", "Beuningen", "Venray", "Putten", 
"Veendam", "Landsmeer", "Oostzaan", "Haaksbergen", "Albrandswaard", 
"Blaricum", "Ermelo", "Bloemendaal", "Loon op Zand", "Nuenen. Gerwen en Nederwetten", 
"Harlingen", "Maashorst", "Urk", "Heusden", "Doetinchem", "Bodegraven-Reeuwijk", 
"Hoogeveen", "Wijk bij Duurstede", "Vught", "Laren (NH.)", "Nijkerk", 
"Wijchen", "Rijssen-Holten", "Boxtel", "Meppel", "Stichtse Vecht", 
"Gilze en Rijen", "Geertruidenberg", "Duiven", "Winterswijk", 
"Vaals", "Uitgeest", "Dongen", "Goirle", "Smallingerland", "Stede Broec", 
"Borne", "Midden-Delfland", "Zuidplas", "Woerden", "Westervoort", 
"Waalwijk", "Goes", "Weert", "Bunschoten", "De Bilt", "Leusden", 
"Oss", "Castricum", "Edam-Volendam", "Kampen", "Wormerland", 
"Best", "Wassenaar", "Sittard-Geleen", "Geldrop-Mierlo", "Valkenswaard", 
"Tiel", "Assen", "Lelystad", "Ouder-Amstel", "Soest", "Roermond", 
"Dijk en Waard", "Lansingerland", "Rheden", "Heiloo", "Uithoorn", 
"Ede", "Oldenzaal", "Westland", "Noordwijk", "Oosterhout", "Enkhuizen", 
"Almelo", "Harderwijk", "Hellevoetsluis", "Houten", "Zutphen", 
"Culemborg", "Teylingen", "Venlo", "Alblasserdam", "Haarlemmermeer", 
"Hillegom", "Baarn", "Lisse", "Landgraaf", "Zeist", "Sliedrecht", 
"Waddinxveen", "Leeuwarden", "Almere", "Deventer", "Roosendaal", 
"Etten-Leur", "Pijnacker-Nootdorp", "Middelburg (Z.)", "'s-Hertogenbosch", 
"Helmond", "Veldhoven", "Heemstede", "Gorinchem", "Apeldoorn", 
"Bergen op Zoom", "Alphen aan den Rijn", "Gooise Meren", "Hoorn", 
"Kerkrade", "Den Helder", "Brunssum", "Ridderkerk", "Voorschoten", 
"Barendrecht", "Oegstgeest", "Zandvoort", "Hengelo (O.)", "Weesp", 
"Heerlen", "IJsselstein", "Zwolle", "Papendrecht", "Nissewaard", 
"Zaanstad", "Velsen", "Enschede", "Breda", "Vlissingen", "Wageningen", 
"Hendrik-Ido-Ambacht", "Krimpen aan den IJssel", "Arnhem", "Nieuwegein", 
"Huizen", "Alkmaar", "Veenendaal", "Maassluis", "Zwijndrecht", 
"Groningen", "Purmerend", "Amersfoort", "Nijmegen", "Katwijk", 
"Tilburg", "Maastricht", "Heemskerk", "Gouda", "Dordrecht", "Capelle aan den IJssel", 
"Leiderdorp", "Zoetermeer", "Eindhoven", "Amstelveen", "Hilversum", 
"Diemen", "Beverwijk", "Leidschendam-Voorburg", "Utrecht", "Rotterdam", 
"Vlaardingen", "Schiedam", "Rijswijk (ZH.)", "Delft", "'s-Gravenhage ", 
"Haarlem", "Leiden", "Amsterdam"), 
urbscore = c(56L, 0L, 0L, 0L, 0L, 0L, 0L, 4L, 4L, 5L, 5L, 5L, 5L, 5L, 6L, 
7L, 8L, 8L, 8L, 9L, 9L, 9L, 9L, 9L, 9L, 9L, 10L, 10L, 10L, 11L, 
11L, 11L, 11L, 11L, 11L, 12L, 12L, 12L, 12L, 12L, 12L, 12L, 12L, 
12L, 12L, 13L, 13L, 13L, 13L, 13L, 13L, 14L, 14L, 14L, 14L, 14L, 
15L, 15L, 15L, 15L, 16L, 16L, 16L, 16L, 16L, 16L, 17L, 17L, 17L, 
17L, 17L, 18L, 18L, 18L, 18L, 18L, 19L, 19L, 19L, 19L, 19L, 19L, 
19L, 19L, 19L, 20L, 20L, 20L, 20L, 20L, 20L, 21L, 21L, 21L, 21L, 
21L, 21L, 21L, 22L, 22L, 22L, 22L, 22L, 22L, 22L, 22L, 23L, 23L, 
23L, 23L, 23L, 23L, 24L, 24L, 24L, 24L, 25L, 25L, 25L, 25L, 25L, 
25L, 25L, 26L, 26L, 26L, 26L, 26L, 26L, 26L, 26L, 26L, 26L, 26L, 
27L, 28L, 28L, 28L, 28L, 28L, 28L, 28L, 28L, 28L, 28L, 30L, 30L, 
30L, 30L, 30L, 30L, 31L, 31L, 31L, 31L, 32L, 32L, 33L, 33L, 33L, 
33L, 33L, 34L, 34L, 34L, 34L, 34L, 34L, 34L, 35L, 35L, 35L, 35L, 
35L, 36L, 36L, 36L, 37L, 37L, 38L, 38L, 38L, 38L, 39L, 39L, 39L, 
40L, 40L, 40L, 41L, 41L, 41L, 41L, 41L, 42L, 42L, 42L, 42L, 43L, 
43L, 43L, 43L, 44L, 44L, 44L, 44L, 44L, 44L, 44L, 45L, 45L, 45L, 
45L, 45L, 46L, 46L, 46L, 46L, 47L, 47L, 47L, 47L, 48L, 48L, 48L, 
49L, 49L, 49L, 51L, 51L, 51L, 51L, 51L, 51L, 52L, 52L, 53L, 53L, 
53L, 54L, 54L, 54L, 54L, 55L, 55L, 55L, 55L, 55L, 56L, 56L, 56L, 
56L, 57L, 57L, 57L, 57L, 57L, 59L, 59L, 59L, 59L, 59L, 59L, 59L, 
60L, 60L, 60L, 60L, 60L, 60L, 60L, 61L, 61L, 61L, 62L, 62L, 62L, 
63L, 63L, 63L, 63L, 63L, 63L, 63L, 63L, 64L, 64L, 64L, 64L, 65L, 
66L, 66L, 66L, 67L, 67L, 67L, 68L, 68L, 69L, 69L, 69L, 70L, 70L, 
70L, 71L, 71L, 71L, 71L, 71L, 72L, 73L, 73L, 73L, 74L, 74L, 75L, 
75L, 75L, 76L, 76L, 76L, 77L, 77L, 77L, 78L, 80L, 80L, 81L, 82L, 
82L, 82L, 83L, 84L, 84L, 86L, 88L, 89L, 89L, 90L, 91L, 91L, 92L, 
93L, 94L, 94L, 95L)), 
row.names = c(NA, -346L), class = "data.frame")

Dp$urbscore <- Dp$urbscore/100  

# split D into separate data frames before fitting the models
Da <- D[D$substance=='amfetamine',]
Db <- D[D$substance=='benzoylecgonine',]
Dm <- D[D$substance=='MDMA',]

# Note: there is one value of 0 in Dm. the Gamma-GLM can't handle that. 
# We replace it with a value of 0.1
Dm$value[Dm$value==0] <- 0.1

# create empty data frame to store results
result <- data.frame(municipality=Dp$municipality, 
                     urbscore=Dp$urbscore,
                     coca_avg=NA, coca_cilo=NA, coca_cihi=NA,
                     amph_avg=NA, amph_cilo=NA, amph_cihi=NA,
                     mdma_avg=NA, mdma_cilo=NA, mdma_cihi=NA)


#### 1 Defining functions ####

# fitpred: function to fit a GLM for a given data set and precict for new values
# of the 'urbanity score', usc; this function is called from cbb_glm()

fitpred <- function(data=Da, usc=seq(from=0,to=1,by=0.05)){
  
  # fit model
  mod <- glm(value ~ urbscore+day, data=data, family=Gamma(link = "log"))
  
  # make prediction with this model
  out <- (predict(mod, newdata=data.frame(urbscore=usc, day='zo'), type='response') +
            predict(mod, newdata=data.frame(urbscore=usc, day='ma'), type='response') +
            predict(mod, newdata=data.frame(urbscore=usc, day='di'), type='response') +
            predict(mod, newdata=data.frame(urbscore=usc, day='wo'), type='response') +
            predict(mod, newdata=data.frame(urbscore=usc, day='do'), type='response') +
            predict(mod, newdata=data.frame(urbscore=usc, day='vr'), type='response') +
            predict(mod, newdata=data.frame(urbscore=usc, day='za'), type='response'))/7
  
  return(out)
}

# cbb_glm: function to perform a case-based GLM-bootstrap

cbb_glm <- function(data=Da, usc=seq(from=0,to=1,by=0.05), bootnr=100){
  
  out <- matrix(NA, nrow=bootnr, ncol=length(usc))
  
  for(i in 1:bootnr){
    
    # resample from dataset
    nrow <- nrow(data)
    idx <- sample(1:nrow, size=nrow, replace=TRUE)
    redata <- data[idx,]
    
    # fit model on redata and make prediction with this model for newdata usc
    out[i,] <- fitpred(data=redata, usc=usc)
  }
  
  # organize model output
  predavg <- fitpred(data=data, usc=usc)
  predsd <- apply(out, MARGIN = 2, sd)
  predquant <- apply(out, MARGIN = 2, quantile, probs=c(0.025, 0.5, 0.975))
  
  output <- as.data.frame(t(rbind(usc, predavg, predsd, predquant)))
  names(output) <- c('x','mean','sd','cilo','median','cihi')
  
  return(output)
}


#### 2 Fit models ####
##### 2a Fit separate models for each of the substances and check the results #####

# amfetamine
ma <- glm(value ~ urbscore+day, data=Da, family=Gamma(link = "log"))
cat('\n\nModel for Amphetamine\n\n')
print(summary(ma))
# R2 based on prediction~observation is 0.02
#   cor(Da$value, predict(ma, type="response"))^2

# cocaïne
mb <- glm(value ~ urbscore+day, data=Db, family=Gamma(link='log'))
cat('\n\nModel for Cocaïne\n\n')
print(summary(mb))
# R2 based on prediction~observation is 0.64
#   cor(Db$value, predict(mb, type="response"))^2

# mdma
mm <- glm(value ~ urbscore+day, data=Dm, family=Gamma(link='log'))
cat('\n\nModel for MDMA\n\n')
print(summary(mm))
# R2 based on prediction~observation is 0.30
#   cor(Dm$value, predict(mm, type="response"))^2


##### 2b Calculate predictions with prediction intervals #####

cat('Patience: now calculating the confidence intervals using bootstrapping ... \n')

set.seed <- 12321
ma_bs <- cbb_glm(data=Da, bootnr=1000)
mb_bs <- cbb_glm(data=Db, bootnr=1000)
mm_bs <- cbb_glm(data=Dm, bootnr=1000)

# fit loess smoothers through the confidence-intervals, so 
# that consistent predictions can be made
ma_cilo_smt <- loess(cilo~x, data=ma_bs)
ma_cihi_smt <- loess(cihi~x, data=ma_bs)

mb_cilo_smt <- loess(cilo~x, data=mb_bs)
mb_cihi_smt <- loess(cihi~x, data=mb_bs)

mm_cilo_smt <- loess(cilo~x, data=mm_bs)
mm_cihi_smt <- loess(cihi~x, data=mm_bs)

# check the resulting confidence-intervals for the predictions visually

xp <- seq(from=0, to=1, by=0.01)
  
plot(mean~x, data=ma_bs, ylim=c(140,320), type='l', 
     main='amphetamine', xlab='urbscore')
points(cilo~x, data=ma_bs, col='red')
points(cihi~x, data=ma_bs, col='red')
lines( predict(ma_cilo_smt,data.frame(x=xp))~xp, col='red' )
lines( predict(ma_cihi_smt,data.frame(x=xp))~xp, col='red' )

plot(mean~x, data=mb_bs, ylim=c(140,1000), type='l', 
     main='cocaïne', xlab='urbscore')
points(cilo~x, data=mb_bs, col='red')
points(cihi~x, data=mb_bs, col='red')
lines( predict(mb_cilo_smt,data.frame(x=xp))~xp, col='red' )
lines( predict(mb_cihi_smt,data.frame(x=xp))~xp, col='red' )

plot(mean~x, data=mm_bs, ylim=c(30,170), type='l',
     main='mdma', xlab='urbscore')
points(cilo~x, data=mm_bs, col='red')
points(cihi~x, data=mm_bs, col='red')
lines( predict(mm_cilo_smt,data.frame(x=xp))~xp, col='red' )
lines( predict(mm_cihi_smt,data.frame(x=xp))~xp, col='red' )


#### 3 Save results ####

# put the calculated values in the results data frame
result$coca_avg <- round(fitpred(data=Db, usc=Dp$urbscore), 0)
result$amph_avg <- round(fitpred(data=Da, usc=Dp$urbscore), 0)
result$mdma_avg <- round(fitpred(data=Dm, usc=Dp$urbscore), 0)
result$coca_cilo <- round(predict(mb_cilo_smt, data.frame(x=Dp$urbscore)), 0)
result$coca_cihi <- round(predict(mb_cihi_smt, data.frame(x=Dp$urbscore)), 0)
result$amph_cilo <- round(predict(ma_cilo_smt, data.frame(x=Dp$urbscore)), 0)
result$amph_cihi <- round(predict(ma_cihi_smt, data.frame(x=Dp$urbscore)), 0)
result$mdma_cilo <- round(predict(mm_cilo_smt, data.frame(x=Dp$urbscore)), 0)
result$mdma_cihi <- round(predict(mm_cihi_smt, data.frame(x=Dp$urbscore)), 0)

# save results
write.csv(result, file="prediction_per_municipality.csv",row.names = FALSE)

cat('\n\nDone. Results are written to the file prediction_per_municipality.csv\n\n')
